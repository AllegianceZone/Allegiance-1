<!-- 
	Imago <imagotrigger@gmail.com>
	 This file must be pasted into http://trac.alleg.net/admin/bitten/configs/R6
	  Please keep it in sync with above
-->














<build xmlns:sh="http://bitten.edgewall.org/tools/sh" xmlns:svn="http://bitten.edgewall.org/tools/svn" description="Building FAZR6 Branch">


<step id="Checkout">
   <sh:exec file="perl" args="${cdn.path}\\update\\touch.pl 1"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision}"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/>
   <sh:exec file="echo" args="Checkout started"/>
   <sh:exec file="svn" args="revert ${cdn.path}\\src\\Inc\\slmver.h"/>
   <sh:exec file="svn" args="revert -R ${cdn.path}\\VS2010"/>
   <!-- <sh:exec file="svn" args="revert -R ${cdn.path}\\VS2008"/> -->
   <svn:checkout url="http://trac.alleg.net/svn/" path="${path}" revision="${revision}" dir="${cdn.path}"/>
   <sh:exec file="echo" args="Checkout completed"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\slmver.pl ${build} 1"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
 </step>


 <step id="Debug Compile">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} Checkout"/> -->
   <sh:exec file="echo" args="FZDebug build started"/>
   <sh:exec file="msbuild.exe" args="/m ${cdn.path}\\VS2010\\Allegiance.sln /logger:Rodemeyer.MsBuildToCCNet.MsBuildToCCNetLogger,${cdn.path}\\update\\logger.dll;${cdn.path}\\update\\msbuild.xml /noconlog /nologo /p:Configuration=FZDebug /t:build"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\msbuild-result.pl ${path} ${build}"/>
   <sh:exec file="echo" args="FZDebug build completed"/>
  <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
 </step>


<step id="Smoke Test">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Debug Compile&quot;"/> -->
   <sh:exec file="perl" args="${cdn.path}\\update\\change_beta_server_registry.pl ${cdn.path}\\objs10\\FZDebug\\FedSrv\\Artwork ${build} ${revision}"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\test.pl ${cdn.path}\\objs10\\FZDebug\\FedSrv\\AllSrv.exe &quot;allsrv -Core2Text cc_09b&quot; ."/>
   <sh:exec file="perl" args="${cdn.path}\\update\\change_beta_server_registry.pl C:\\AllegBeta\\Artwork ${build} ${revision}"/>   
   <sh:exec file="echo" args="Running Allsrv.exe -Core2Text cc_09b completed"/>   
   <sh:exec file="copy" args="C:\\Inetpub\\wwwroot\\build\\CoreChecker\\corechecker.pl ${cdn.path}\\objs10\\FZDebug\\FedSrv\\Artwork\\cc_09b\\corechecker.pl /Y"/>
   <sh:exec file="C:\\Inetpub\\wwwroot\\build\\CoreChecker\\runon.bat" args="${cdn.path}\\objs10\\FZDebug\\FedSrv\\Artwork\\cc_09b"/>
   <sh:exec file="echo" args="Checking core completed"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/>
</step>

 <step id="Release Compile Beta">
   <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Smoke Test passed!&quot;"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\vcxproj.pl 0 1"/>
   <sh:exec file="echo" args="FZRetail 1.1 rebuild started"/>
   <!-- <sh:exec file="msbuild.exe" args="${cdn.path}\\VS2010\\Allegiance.sln /logger:Rodemeyer.MsBuildToCCNet.MsBuildToCCNetLogger,${cdn.path}\\update\\logger.dll;${cdn.path}\\update\\msbuild.xml /v:quiet /noconlog /nologo /p:Configuration=FZRetail /t:clean"/> -->
   <sh:exec file="msbuild.exe" args="/m ${cdn.path}\\VS2010\\Allegiance.sln /logger:Rodemeyer.MsBuildToCCNet.MsBuildToCCNetLogger,${cdn.path}\\update\\logger.dll;${cdn.path}\\update\\msbuild.xml /noconlog /nologo /p:Configuration=FZRetail /t:rebuild"/>
   <sh:exec file="perl.exe" args="${cdn.path}\\update\\msbuild-result.pl ${path} ${build}"/>
   <sh:exec file="echo" args="FZRetail 1.1 rebuild completed"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
 </step>



<step id="Package 1.1">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Release Compile Beta&quot;"/> -->
	<sh:exec file="echo" args="Copying externals"/>
	<sh:exec file="del" args=" ${cdn.root}\\Package\\External.7z"/>	
	<sh:exec file="del" args=" ${cdn.root}\\Package\\Release.7z"/>	
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z ${cdn.root}\\Package\\External.7z ${cdn.root}\\External\\* -mx9 -x!ASGS*"/>
	<sh:exec file="echo" args="Copying externals completed"/>

	<sh:exec file="echo" args="Not signing objects, no FAO allowed certificate (yet)"/>
	<!-- <sh:exec file="${cdn.path}\\update\\sign.bat" args="FZRetail"/>
	<sh:exec file="echo" args="Signing objects completed"/> -->

	<sh:exec file="echo" args="Copying objects"/>
	<!-- <sh:exec file="${cdn.path}\\Sh_GetDebug.bat" args="${cdn.path}\\x86 ${cdn.path}\\"/> <sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a ${cdn.path}\\Package\\Debug.7z ${cdn.path}\\x86\\* -x!m*.dll -x!atl*.dll -xr!*.svn"/> -->
	<sh:exec file="${cdn.path}\\Sh_GetRetail.bat" args="${cdn.path}\\x86 ${cdn.path}\\"/>
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z C:\\inetpub\\wwwroot\\build\\AllegR6PDB_b${build}_r${revision}.exe ${cdn.path}\\x86\\*.pdb -mx9" />
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z ${cdn.root}\\Package\\Release.7z ${cdn.path}\\x86\\* -x!*.pdb -xr!*.svn -mx9" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\Allegiance.exe C:\\Allegiance.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\Allsrv.exe C:\\Allsrv.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\AllsrvUI.exe C:\\AllsrvUI.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\AGC.dll C:\\AGC.dll /Y" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\Reloader.exe C:\\Reloader.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\x86\\AutoUpdate.exe C:\\AutoUpdate.exe /Y" />	
	<sh:exec file="echo" args="Copying objects completed"/>

	<sh:exec file="echo" args="Copying artwork"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\au.pl"/>
	<sh:exec file="copy" args="${cdn.root}\\Package\\Artwork.7z C:\\Inetpub\\wwwroot\\build\\AllegR6ART_b${build}_r${revision}.exe /Y"/>
	<sh:exec file="echo" args="Copying artwork completed"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
</step>

<step id="Mirror 1.1">
	<sh:exec file="perl" args="${cdn.path}\\update\\cloud\\nsis_mirror.pl -b ${build} -r ${revision} -v 1.1" />
</step>

<step id="Publish 1.1">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Package 1.1&quot;"/> -->
	<sh:exec file="echo" args="Creating installer"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\nsis.pl 1.1 ${build} ${revision} 0"/>
	<!-- <sh:exec file="${cdn.path}\\update\\sign-installer.bat" args="R6_b${build}_r${revision}.exe 1"/> -->
	<sh:exec file="echo" args="Completed creating installer"/>

	<sh:exec file="echo" args="Attaching Lite"/>
	<attach file="C:\\Inetpub\\wwwroot\\build\\R6_b${build}_r${revision}.exe" resource="build" description="Lite 1.1 version" />
	<sh:exec file="echo" args="Download: http://build.alleg.net/R6_b${build}_r${revision}.exe"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\announce-dl.pl ${build} ${revision} &quot;Download: http://build.alleg.net/R6_b${build}_r${revision}.exe [Beta (1.1)]&quot;"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
</step>

<step id="Remote Tests">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Package 1.0&quot;"/> -->
   	<sh:exec file="echo" args="Cleaning up previous install"/>
	<sh:exec file="echo" args="Deploying to fuzztest.dyndns.org"/>
	<sh:exec file="echo" args="Waiting for ready"/>
	<sh:exec file="echo" args="Report started"/>
	<sh:exec file="echo" args="Test: Sanity test started"/>
	<sh:exec file="echo" args="Sanity test FAILED"/>
	<sh:exec file="echo" args="Test: Quick launch test started"/>
	<sh:exec file="echo" args="Quick launch test FAILED"/>	
	<sh:exec file="echo" args="Test: CortUI 1.75 test started"/>
	<sh:exec file="echo" args="CortUI 1.75 test FAILED"/>	
	<sh:exec file="echo" args="Attaching report NYI"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
</step>

 <step id="Release Compile Prod">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Publish 1.1&quot;"/> -->
   <sh:exec file="svn" args="revert -R ${cdn.path}\\VS2010"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\slmver.pl ${build} 0"/>
   <sh:exec file="perl" args="${cdn.path}\\update\\vcxproj.pl 1 1"/>
   <sh:exec file="echo" args="FZRetail 1.0 rebuild started"/>
   <!-- <sh:exec file="msbuild.exe" args="${cdn.path}\\VS2010\\Allegiance.sln /logger:Rodemeyer.MsBuildToCCNet.MsBuildToCCNetLogger,${cdn.path}\\update\\logger.dll;${cdn.path}\\update\\msbuild.xml /v:quiet /noconlog /nologo /p:Configuration=FZRetail /t:clean"/> -->
   <sh:exec file="msbuild.exe" args="/m ${cdn.path}\\VS2010\\Allegiance.sln /logger:Rodemeyer.MsBuildToCCNet.MsBuildToCCNetLogger,${cdn.path}\\update\\logger.dll;${cdn.path}\\update\\msbuild.xml /noconlog /nologo /p:Configuration=FZRetail /t:rebuild"/>
   <sh:exec file="perl.exe" args="${cdn.path}\\update\\msbuild-result.pl ${path} ${build}"/>
   <sh:exec file="echo" args="FZRetail 1.0 rebuild completed"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
 </step>

<step id="Package 1.0">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Release Compile Prod&quot;"/> -->
	<sh:exec file="echo" args="Copying externals"/>
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z ${cdn.root}\\Package\\External.7z ${cdn.root}\\External\\* -mx9"/>
	<sh:exec file="echo" args="Copying externals completed"/>
	<sh:exec file="del" args=" ${cdn.root}\\Package\\Release.7z"/>
	
	<sh:exec file="echo" args="Not signing objects, no FAO allowed certificate (yet)"/>
	<!-- <sh:exec file="${cdn.path}\\update\\sign.bat" args="FZRetail"/>
	<sh:exec file="echo" args="Signing objects completed"/> -->

	<sh:exec file="echo" args="Copying objects"/>
	<sh:exec file="${cdn.path}\\Sh_GetRetail.bat" args="${cdn.path}\\x86 ${cdn.path}\\"/>
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z C:\\inetpub\\wwwroot\\build\\AllegPDB_b${build}_r${revision}.exe ${cdn.path}\\x86\\*.pdb -mx9" />
	<sh:exec file="C:\\Program Files\\7-Zip\\7z.exe" args="a -t7z ${cdn.root}\\Package\\Release.7z ${cdn.path}\\x86\\* -x!*.pdb -xr!*.svn -mx9" />
	<sh:exec file="echo" args="Copying objects completed"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
</step>

<step id="Mirror 1.0">
	<sh:exec file="perl" args="${cdn.path}\\update\\cloud\\nsis_mirror.pl -b ${build} -r ${revision} -v 1.0" />
</step>

<step id="Publish 1.0">
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\announce-step.pl ${build} ${revision} &quot;Package 1.0&quot;"/> -->
	<sh:exec file="echo" args="Creating installer"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\nsis.pl 1.0 ${build} ${revision} 1"/>
	<!-- <sh:exec file="${cdn.path}\\update\\sign-installer.bat" args="Alleg_b${build}_r${revision}.exe 0"/>  -->
	<!-- <sh:exec file="perl" args="${cdn.path}\\update\\nsis.pl 1.0 ${build} ${revision} 0"/> -->
	<!-- <sh:exec file="${cdn.path}\\update\\sign-installer.bat" args="Alleg_lite_b${build}_r${revision}.exe 0"/>  -->
	<sh:exec file="echo" args="Completed creating installer"/>

	<!-- <sh:exec file="echo" args="Attaching Lite"/> -->
	<!-- <attach file="${cdn.path}\\update\\Inetpub\\wwwroot\\build\\Alleg_lite_b${build}_r${revision}.exe" resource="build" description="Lite 1.0 version" /> -->
	<sh:exec file="echo" args="Download: http://build.alleg.net/Alleg_b${build}_r${revision}.exe"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\announce-dl.pl ${build} ${revision} &quot;Download: http://build.alleg.net/Alleg_b${build}_r${revision}.exe [Production (1.0)]&quot;"/>
   <!-- <sh:exec file="perl" args="${cdn.path}\\update\\step.pl"/> -->
</step>

<step id="Upgrade Started">
	<sh:exec file="echo" args="Killing any zombie build procs" />
	<sh:exec file="perl" args="${cdn.path}\\update\\msbuild-kill.pl" />
	<sh:exec file="echo" args="Gracefully stopping CDN AllSrv" /> 
	<sh:exec file="perl" args="${cdn.path}\\update\\shutdown.pl" />
	<sh:exec file="echo" args="Unregistering AGC.dll" />
	<sh:exec file="regsvr32" args="C:\\AllegBeta\\AGC.dll /u /s" />
	<sh:exec file="echo" args="Copying new versions" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\AGC\\AGC.dll C:\\AllegBeta\\AGC.dll /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\FedSrv\\AllSrv.exe C:\\AllegBeta\\AllSrv.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\Lobby\\AllLobby.exe C:\\AllegBeta\\AllLobby.exe /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\AGC\\AGC.pdb C:\\AllegBeta\\AGC.pdb /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\FedSrv\\AllSrv.pdb C:\\AllegBeta\\AllSrv.pdb /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\Lobby\\AllLobby.pdb C:\\AllegBeta\\AllLobby.pdb /Y" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\AutoUpdate\\AutoUpdate.exe C:\\AllegBeta\\AutoUpdate.exe /Y" />
	<sh:exec file="echo" args="Registering new AGC.dll" />
	<sh:exec file="regsvr32" args="C:\\AllegBeta\\AGC.dll /s" />
	<sh:exec file="echo" args="Re-registering AllSrv.exe as a service" />
	<sh:exec file="C:\\AllegBeta\\AllSrv.exe" args="-service" />
</step>	

<step id="Deploy Beta">
	<sh:exec file="echo" args="Updating AutoUpdate" />
	<sh:exec file="copy" args="${cdn.path}\\objs10\\FZDebug\\AutoUpdate\\AutoUpdate.exe C:\\AllegBeta\\AutoUpdate.exe /Y" />
	<sh:exec file="echo" args="Making file lists" />
	<sh:exec file="perl" args="${cdn.path}\\update\\makelist.pl" />
	<sh:exec file="echo" args="Making MOTD" />
	<sh:exec file="perl" args="${cdn.path}\\update\\makemotd.pl ${build} ${revision}" />
	<sh:exec file="echo" args="Making cfg file" />
	<sh:exec file="perl" args="${cdn.path}\\update\\makecfg.pl" />
	<sh:exec file="echo" args="Performing remote upgrade..." />
	<sh:exec file="perl" args="${cdn.path}\\update\\deploy.pl" />
	<sh:exec file="echo" args="...Done" />
</step>

<step id="Upgrade Finished">
	<sh:exec file="perl" args="${cdn.path}\\update\\allsrv.pl" />
</step>	

<step id="Done">
	<sh:exec file="perl" args="${cdn.path}\\update\\touch.pl"/>
	<sh:exec file="perl" args="${cdn.path}\\update\\announce.pl ${build} ${revision}"/>
</step>

</build>